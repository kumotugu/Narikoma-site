
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒŠãƒªã¡ã‚ƒã‚“ã®ãŠå›°ã‚Šã”ã¨ç›¸è«‡å®¤</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .chat-container {
            width: 400px;
            height: 600px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®èƒŒæ™¯ã‚’èµ¤è‰²ã«å¤‰æ›´ */
        .chat-header {
            background-color: #D32F2F;
            color: white;
            padding: 15px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            text-align: center;
        }

        .chatbox {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
        }

            .message p {
                padding: 10px 15px;
                border-radius: 18px;
                max-width: calc(80% - 75px);
                line-height: 1.4;
                position: relative;
            }

        /* ğŸ’¡ ã‚¢ã‚¤ã‚³ãƒ³ã®CSS */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

            /* ğŸ’¡ imgã‚¿ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
            .avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover; /* ç”»åƒãŒè¦ç´ ã«åã¾ã‚‹ã‚ˆã†ã«èª¿æ•´ */
            }

        /* ğŸ’¡ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ£ãƒƒãƒˆï¼ˆFlexboxã«å¤‰æ›´ã—å³å¯„ã›ï¼‰ */
        .user {
            display: flex;
            justify-content: flex-end; /* å³å¯„ã› */
            margin-right: -20px;
        }

            .user p {
                background-color: #D32F2F;
                color: white;
                margin-right: 0;
            }

                /* ğŸ’¡ ãƒ¦ãƒ¼ã‚¶ãƒ¼å¹ãå‡ºã—ã®ã—ã£ã½ï¼ˆå³å‘ãï¼‰ */
                .user p::before {
                    content: '';
                    position: absolute;
                    top: 10px;
                    right: -21px; /* å¹ãå‡ºã—ã®å³ç«¯ã‹ã‚‰å¤–å´ã¸çªãå‡ºã™ */
                    border: 15px solid transparent; /* ã—ã£ã½ã®ã‚µã‚¤ã‚º */
                    border-left-color: #D32F2F;
                }

        /* ğŸ’¡ AIã®ãƒãƒ£ãƒƒãƒˆï¼ˆFlexboxã«å¤‰æ›´ã€ã‚¢ã‚¤ã‚³ãƒ³ã¨å¹ãå‡ºã—ã‚’ä¸­å¤®æƒãˆï¼‰ */
        .ai {
            display: flex;
            align-items: center; /* ğŸ’¡ ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³ã¨å¹ãå‡ºã—ã‚’å‚ç›´æ–¹å‘ã®ä¸­å¤®ã§æƒãˆã‚‹ */
        }

            .ai p {
                background-color: #e9e9eb;
                color: #333;
                margin-left: 15px; /* ğŸ’¡ ä¿®æ­£: ã‚¢ã‚¤ã‚³ãƒ³ã¨å¹ãå‡ºã—ã®é–“éš”ã‚’èª¿æ•´ */
            }

                /* ğŸ’¡ AIå¹ãå‡ºã—ã®ã—ã£ã½ï¼ˆå·¦å‘ãï¼‰ */
                .ai p::before {
                    content: '';
                    position: absolute;
                    top: 10px;
                    left: -25px; /* å¹ãå‡ºã—ã®å·¦ç«¯ã‹ã‚‰å¤–å´ã¸çªãå‡ºã™ */
                    border: 15px solid transparent; /* ã—ã£ã½ã®ã‚µã‚¤ã‚º */
                    border-right-color: #e9e9eb; /* å¹ãå‡ºã—ã¨åŒã˜è‰² */
                }

        .input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
        }

        #userInput {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 18px;
            padding: 10px;
            font-size: 14px;
        }

            /* å…¥åŠ›æ¬„ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è‰²ã‚’èµ¤è‰²ã«å¤‰æ›´ */
            #userInput:focus {
                outline: none;
                border-color: #D32F2F;
            }

        /* é€ä¿¡ãƒœã‚¿ãƒ³ã®èƒŒæ™¯ã‚’èµ¤è‰²ã«å¤‰æ›´ */
        button {
            background-color: #D32F2F;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 18px;
        }

        /* ğŸ’¡ ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .flow-control p button {
            background-color: #3f51b5; /* é’ç³» */
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            margin-top: 5px;
            margin-right: 5px;
            cursor: pointer;
            width: auto; /* å¹…ã‚’ãƒªã‚»ãƒƒãƒˆ */
            height: auto; /* é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆ */
            font-size: 14px;
        }

            .flow-control p button:disabled {
                background-color: #90a4ae; /* ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ */
                cursor: default;
            }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header"><h2>ãƒŠãƒªã¡ã‚ƒã‚“ã®ãŠå›°ã‚Šã”ã¨ç›¸è«‡å®¤</h2></div>
        <div class="chatbox" id="chatbox">
            <div class="message ai">
                <div class="avatar">
                    <img src="narikoma.jpg" alt="ãƒŠãƒªã¡ã‚ƒã‚“ã®ã‚¢ã‚¤ã‚³ãƒ³">
                </div>
                <p>ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</p>
            </div>
        </div>
        <div class="input-area" id="inputArea">
            <input type="text" id="userInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
            <button onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <script>
        // çŠ¶æ…‹ç®¡ç†ç”¨ã®å¤‰æ•°ï¼ˆã€Œã„ã„ãˆã€ãŒæŠ¼ã•ã‚ŒãŸå›æ•°ï¼‰
        let noCount = 0;
        const MAX_ATTEMPTS = 3; // maxã®å›æ•°

        // JavaScript (ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ããƒ—ãƒ­ã‚°ãƒ©ãƒ )
        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const chatbox = document.getElementById('chatbox');
            const question = userInput.value.trim();

            if (!question) return;

            // è‡ªåˆ†ã®è³ªå•ã‚’ç”»é¢ã«è¿½åŠ 
            chatbox.innerHTML += `<div class="message user"><p>${question}</p></div>`;
            userInput.value = '';
            chatbox.scrollTop = chatbox.scrollHeight;

            // è£æ–¹ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ (/ask)ã«è³ªå•ã‚’é€ä¿¡ã™ã‚‹
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã‚’å–å¾— (ã“ã“ã§ã¯ä»®ã®å¿œç­”ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨)
            let answer = "ã€Œ" + question + "ã€ã§ã™ã­ã€‚AIã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒå›ç­”ã—ã¾ã™ã€‚";
            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });

                const data = await response.json();
                answer = data.answer || data.error || answer;
            } catch (e) {
                // fetchãŒå¤±æ•—ã—ãŸå ´åˆã¯åˆæœŸã®ä»®å¿œç­”ã‚’ä½¿ç”¨
            }

            // AIã®ç­”ãˆã¨ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¿½åŠ 
            // ğŸ’¡ 3. å›ç­”è¡¨ç¤ºå¾Œã€æ–°ã—ã„é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ç”¨ã®HTMLã‚’ç”Ÿæˆ
            handleAnswer(answer);

            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // ğŸ’¡ 4. å›ç­”ã¨ã€Œè§£æ±ºã—ã¾ã—ãŸã‹ï¼Ÿã€ã®ãƒ•ãƒ­ãƒ¼ã‚’ç®¡ç†ã™ã‚‹æ–°ã—ã„é–¢æ•°
        function handleAnswer(answer) {
            const chatbox = document.getElementById('chatbox');

            // AIã®ç­”ãˆã‚’ç”»é¢ã«è¿½åŠ 
            chatbox.innerHTML += `
                <div class="message ai">
                    <div class="avatar">
                        <img src="narikoma.jpg" alt="ãƒŠãƒªã¡ã‚ƒã‚“ã®ã‚¢ã‚¤ã‚³ãƒ³">
                    </div>
                    <p>${answer}</p>
                </div>
            `;

            // ğŸ’¡ ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ç”¨ã®ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            chatbox.innerHTML += `
                <div class="message ai flow-control">
                    <div class="avatar">
                        <img src="narikoma.jpg" alt="ãƒŠãƒªã¡ã‚ƒã‚“ã®ã‚¢ã‚¤ã‚³ãƒ³">
                    </div>
                    <p>è§£æ±ºã—ã¾ã—ãŸã‹ï¼Ÿ

<button onclick="handleFlow('yes', this)">ã¯ã„</button>
                        <button onclick="handleFlow('no', this)">ã„ã„ãˆ</button>
                    </p>
                </div>
            `;
        }

        // ğŸ’¡ 5. ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®ãƒ­ã‚¸ãƒƒã‚¯
        function handleFlow(type, buttonElement) {
            const chatbox = document.getElementById('chatbox');
            const inputArea = document.getElementById('inputArea'); // å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’æœ‰åŠ¹/ç„¡åŠ¹ã«ã™ã‚‹ãŸã‚IDã‚’è¿½åŠ 

            // ã™ã¹ã¦ã®ãƒ•ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹ã«ã™ã‚‹ï¼ˆå¤šé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ï¼‰
            const flowButtons = buttonElement.parentNode.querySelectorAll('button');
            flowButtons.forEach(btn => btn.disabled = true);

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã® div ã‚’æº–å‚™
            let flowMessage = "";

            if (type === 'yes') {
                // --- ã€ã¯ã„ã€‘ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã®ãƒ•ãƒ­ãƒ¼ ---
                flowMessage = "ãŠå½¹ã«ç«‹ã¦ã¦ã‚ˆã‹ã£ãŸã§ã™ï¼ã»ã‹ã«è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ";
                noCount = 0; // ğŸ’¡ ã„ã„ãˆã®ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ

            } else {
                // --- ã€ã„ã„ãˆã€‘ãŒæŠ¼ã•ã‚ŒãŸå ´åˆã®ãƒ•ãƒ­ãƒ¼ ---
                noCount++;

                if (noCount >= MAX_ATTEMPTS) {
                    // 3å›ä»¥ä¸Šã«é”ã—ãŸå ´åˆ
                    const displayPhoneNumber = '012-3456-7890'; // ğŸ’¡ é›»è©±ç•ªå·ã‚’è¨­å®š
                    const rawPhoneNumber = '01234567890';

                    const telLink = `<a href="tel:${rawPhoneNumber}" style="color: #D32F2F; text-decoration: underline;">${displayPhoneNumber}</a>`;

                    flowMessage = `ãŠæ‰‹æ•°ã§ã™ãŒã“ã¡ã‚‰ã¾ã§ãŠé›»è©±ãã ã•ã„ï¼š
<strong>${telLink}</strong>`;
                    // inputArea.style.display = 'none'; // ğŸ’¡ è³ªå•ã®å—ä»˜ã‚’çµ‚äº†ã—ãŸã„å ´åˆã¯å…¥åŠ›æ¬„ã‚’éè¡¨ç¤ºã«

                } else {
                    // 3å›æœªæº€ã®å ´åˆ
                    flowMessage = "ã‚‚ã†ä¸€åº¦æ•™ãˆã¦ãã ã•ã„ã€‚ã€‚";
                }
            }

            // åˆ¶å¾¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¿½åŠ 
            chatbox.innerHTML += `
                <div class="message ai flow-response">
                    <div class="avatar">
                        <img src="narikoma.jpg" alt="ãƒŠãƒªã¡ã‚ƒã‚“ã®ã‚¢ã‚¤ã‚³ãƒ³">
                    </div>
                    <p>${flowMessage}</p>
                </div>
            `;

            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ã®é€ä¿¡
        document.getElementById('userInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
